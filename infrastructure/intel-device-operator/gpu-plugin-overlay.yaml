apiVersion: source.toolkit.fluxcd.io/v1beta2
kind: GitRepository
metadata:
  name: intel-device-plugins
  namespace: intel
spec:
  interval: 10m
  url: https://github.com/intel/intel-device-plugins-for-kubernetes
  ref:
    tag: v0.32.1
# ---
# apiVersion: kustomize.toolkit.fluxcd.io/v1beta2
# kind: Kustomization
# metadata:
#   name: gpu-plugin
#   namespace: intel
# spec:
#   interval: 10m
#   path: ./deployments/gpu_plugin
#   prune: true
#   sourceRef:
#     kind: GitRepository
#     name: intel-device-plugins
#   targetNamespace: intel
---
apiVersion: kustomize.toolkit.fluxcd.io/v1beta2
kind: Kustomization
metadata:
  name: gpu-plugin-overlay
  namespace: intel
spec:
  interval: 10m
  path: ./deployments/gpu_plugin/overlays/health
  prune: true
  sourceRef:
    kind: GitRepository
    name: intel-device-plugins
  targetNamespace: intel
  patches:
    - patch: |
        - op: replace
          path: /spec/template/spec/containers/0/args
          value:
            # Enable GPU health management via oneAPI/Level-Zero interface
            # Requires GPU Level-Zero sidecar, reports device as unhealthy if memory/bus issues or temp over limit
            - "-health-management"
            # Number of containers that can share the same GPU device (default: 1)
            # Higher values allow more workloads to share GPU resources
            - "-shared-dev-num"
            - "10"
            # Enable '*_monitoring' resource that provides access to all Intel GPU devices on the node
            # Useful for metrics collection with tools like XPU Manager or Prometheus
            - "-enable-monitoring"
            # Temperature limit at which device is marked unhealthy (default: 100C)
            # Lower values provide more conservative thermal management
            # - "-temp-limit"
            # - "85"
            # GPU allocation policy for shared-dev-num > 1 (default: none)
            # Options: balanced (spreads workloads), packed (fills one GPU first), none (first available)
            - "-allocation-policy"
            - "balanced"
        - op: add
          path: /spec/template/spec/nodeSelector
          value:
            kubernetes.io/hostname: sonda-core
      target:
        kind: DaemonSet
        name: intel-gpu-plugin